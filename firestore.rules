rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users collection: only admins can change status field
    match /users/{userId} {
      allow read: if request.auth != null;

      // Only a master admin may write `status` field
      allow update: if isMasterAdmin() && onlyStatusChanged();

      // Users may create their own document on signup via backend auth flows
      allow create: if request.auth != null && request.auth.uid == userId;

      // other updates only by admin
      allow write: if isMasterAdmin();
    }

    // Profiles: owners can read/write their profile; admins can read/write
    match /profiles/{profileId} {
      allow read: if request.auth != null && (isMasterAdmin() || isOwner());
      allow update: if request.auth != null && (isMasterAdmin() || isOwner());
      allow create: if request.auth != null && (isMasterAdmin() || isOwner());
      allow delete: if isMasterAdmin();
    }

    // Leads: Sales users can create leads assigned to themselves; only assigned sales or admins can edit
    match /leads/{leadId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.salesUserId == request.auth.uid;
      allow update: if request.auth != null && (request.auth.uid == resource.data.salesUserId || isMasterAdmin());
      allow delete: if isMasterAdmin();
    }

    // Customers: Operations users or admins can update; anyone authenticated can read
    match /customers/{custId} {
      allow read: if request.auth != null;
      allow create: if isMasterAdmin() || hasRole('OPERATIONS');
      allow update: if isMasterAdmin() || hasRole('OPERATIONS');
      allow delete: if isMasterAdmin();
    }

    function isMasterAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'MASTER_ADMIN';
    }

    function onlyStatusChanged() {
      return request.resource.data.keys().hasOnly(['status']) || (request.resource.data.status == resource.data.status);
    }

    function isOwner() {
      // profile stores userRef field as "users/<uid>"
      return resource.data.userRef == ('users/' + request.auth.uid) || request.resource.data.userRef == ('users/' + request.auth.uid);
    }

    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Get user data from 'users' collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper: Check roles
    function hasRole(role) {
      return isSignedIn() && getUserData().role == role && getUserData().status == 'APPROVED';
    }

    // --- COLLECTION: USERS ---
    match /users/{userId} {
      // Users can read their own profile; Admins can read/write all
      allow read: if isSignedIn() && (request.auth.uid == userId || getUserData().role == 'MASTER_ADMIN');
      // Registration: allow create if pending
      allow create: if isSignedIn() && request.resource.data.status == 'PENDING';
      // Only Master Admin can approve/change roles
      allow update: if hasRole('MASTER_ADMIN');
    }

    // --- COLLECTION: LEADS ---
    match /leads/{leadId} {
      // Master Admin: Full access
      allow read, write: if hasRole('MASTER_ADMIN');
      // Sales: Only their own leads
      allow read, write: if hasRole('SALES') && (resource == null || resource.data.salesUserId == request.auth.uid);
      // Ops: No access to leads
      allow read: if false;
    }

    // --- COLLECTION: CUSTOMERS ---
    match /customers/{customerId} {
      // Master Admin: Full access
      allow read, write: if hasRole('MASTER_ADMIN');
      
      // Sales: 
      // 1. Can read their own customers.
      // 2. Can ONLY update if status is 'INACTIVE'. Once 'ACTIVE', it is locked for Sales.
      allow read: if hasRole('SALES') && resource.data.salesUserId == request.auth.uid;
      allow update: if hasRole('SALES') && resource.data.salesUserId == request.auth.uid && resource.data.status == 'INACTIVE';
      
      // Operations:
      // 1. Can only see 'ACTIVE' customers.
      // 2. Can update executionStage and internalCost.
      allow read: if hasRole('OPERATIONS') && resource.data.status == 'ACTIVE';
      allow update: if hasRole('OPERATIONS') && resource.data.status == 'ACTIVE' && 
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['executionStage', 'internalCost']);
    }
  }
}
